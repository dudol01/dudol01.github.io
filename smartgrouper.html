<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Smart Seat - iOS Pro</title>
    <style>
        /* --- iOS Design System --- */
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-text: #1C1C1E;
            --ios-gray: #8E8E93;
            --ios-border: #E5E5EA;
            --shadow: 0 2px 8px rgba(0,0,0,0.04);
            --desk-radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            background-color: var(--ios-bg);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            color: var(--ios-text);
            overflow: hidden;
        }

        /* --- ì‚¬ì´ë“œë°” (ì„¤ì •) --- */
        #sidebar {
            width: 360px; /* ì…ë ¥ í•„ë“œê°€ ë§ì•„ì ¸ì„œ ì¡°ê¸ˆ ë„“í˜ */
            background: var(--ios-bg);
            border-right: 1px solid rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 20;
            padding: 20px 0;
        }

        .ios-header { padding: 0 20px 10px 20px; }
        .ios-header h1 { font-size: 24px; font-weight: 800; margin: 0; }

        /* ì„¤ì • ê·¸ë£¹ ë°•ìŠ¤ */
        .list-group {
            background: var(--ios-card);
            border-radius: 12px;
            margin: 0 16px 15px 16px;
            padding: 10px 16px;
            box-shadow: var(--shadow);
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--ios-border);
            font-size: 14px;
        }
        .list-item:last-child { border-bottom: none; }
        .list-label { font-weight: 600; color: #333; }

        /* ì»¤ìŠ¤í…€ ìŠ¬ë¼ì´ë” (Range Input) */
        input[type=range] {
            -webkit-appearance: none;
            width: 120px;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: #FFFFFF;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-top: -8px;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            background: var(--ios-blue);
            border-radius: 2px;
        }

        /* í•™ìƒ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ */
        #student-list-container {
            flex: 1;
            overflow-y: auto;
            margin: 0 16px 10px 16px;
            padding-right: 4px; /* ìŠ¤í¬ë¡¤ë°” ê³µê°„ */
        }
        
        /* í•™ìƒ ì…ë ¥ í–‰ (ë³µì¡í•´ì§) */
        .student-row {
            background: var(--ios-card);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .student-number {
            font-size: 12px; font-weight: bold; color: var(--ios-gray); width: 20px;
        }

        .input-name {
            width: 70px;
            border: none; background: #f2f2f7;
            padding: 6px; border-radius: 6px;
            font-size: 14px; font-weight: 600; text-align: center;
        }
        
        .input-avoid {
            flex: 1;
            border: none; background: #fff0f0; /* ì—°í•œ ë¹¨ê°• ë°°ê²½ */
            padding: 6px; border-radius: 6px;
            font-size: 12px;
            color: var(--ios-red);
        }
        .input-avoid::placeholder { color: #ffb3b3; }

        /* í† ê¸€ ë²„íŠ¼ë“¤ */
        .toggle-btn {
            padding: 5px 8px;
            border-radius: 6px;
            font-size: 12px; font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            user-select: none;
        }
        
        /* ì„±ë³„ í† ê¸€ */
        .gender-m { background: #e3f2fd; color: #007AFF; }
        .gender-f { background: #fce4ec; color: #ff2d55; }
        
        /* ì„±ì  í† ê¸€ */
        .level-high { background: #e8f5e9; color: #2e7d32; }
        .level-mid  { background: #f5f5f5; color: #616161; }
        .level-low  { background: #fff3e0; color: #ef6c00; }

        /* í•˜ë‹¨ ë²„íŠ¼ */
        .bottom-action {
            padding: 16px;
            background: var(--ios-bg);
            backdrop-filter: blur(20px);
        }
        .ios-btn {
            width: 100%;
            background: linear-gradient(135deg, #007AFF, #0051a8);
            color: white; border: none;
            padding: 16px; border-radius: 14px;
            font-size: 17px; font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,122,255,0.3);
            display: flex; justify-content: center; items-center; gap: 8px;
        }
        .ios-btn:active { transform: scale(0.98); }

        /* --- ì˜¤ë¥¸ìª½ êµì‹¤ --- */
        #classroom {
            flex: 1; position: relative;
            background-color: #e5e5ea;
            background-image: radial-gradient(#C7C7CC 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
        }

        #blackboard {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 60%; height: 40px;
            background: #3A3A3C; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            color: #fff; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .desk {
            width: 110px; height: 70px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--desk-radius);
            position: absolute;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            cursor: grab; z-index: 10;
            border: 2px solid transparent;
            transition: transform 0.2s, left 0.4s, top 0.4s;
        }
        .desk span.name { font-size: 16px; font-weight: 700; color: #333; }
        .desk span.info { font-size: 10px; color: #888; margin-top: 2px; }
        
        /* ëª¨ë‘ ë³„ ìƒ‰ìƒ (í…Œë‘ë¦¬ + ë°°ê²½í‹´íŠ¸) */
        .g-1 { border-color: #ff3b30; background: #fff5f5; }
        .g-2 { border-color: #ff9500; background: #fffbf0; }
        .g-3 { border-color: #ffcc00; background: #fffff0; }
        .g-4 { border-color: #34c759; background: #f0fff4; }
        .g-5 { border-color: #007aff; background: #f0f8ff; }
        .g-6 { border-color: #5856d6; background: #f5f5ff; }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loading {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; font-weight: bold; color: var(--ios-blue);
            display: none;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="ios-header">
            <h1>AI ìë¦¬ ë°°ì¹˜ <span style="font-size:14px; color:#888; font-weight:normal;">Pro</span></h1>
        </div>

        <div class="list-group">
            <div class="list-item">
                <span class="list-label">í•™ìƒ ìˆ˜</span>
                <select id="student-count" onchange="initClass()" style="border:none; outline:none; font-weight:bold; color:#007AFF;">
                    </select>
            </div>
            <div class="list-item">
                <span class="list-label">ëª¨ë‘  ìˆ˜</span>
                <select id="group-count" style="border:none; outline:none; font-weight:bold; color:#007AFF;">
                    <option value="2">2ëª¨ë‘ </option>
                    <option value="3">3ëª¨ë‘ </option>
                    <option value="4">4ëª¨ë‘ </option>
                    <option value="5">5ëª¨ë‘ </option>
                    <option value="6" selected>6ëª¨ë‘ </option>
                </select>
            </div>
        </div>

        <div class="ios-header" style="padding-bottom:5px;">
            <span style="font-size:12px; color:var(--ios-gray); font-weight:600;">AI ê°€ì¤‘ì¹˜ (ì¤‘ìš”ë„) ì„¤ì •</span>
        </div>
        <div class="list-group">
            <div class="list-item">
                <span class="list-label" style="font-size:13px;">ğŸ‘« ì„±ë³„ ê· í˜•</span>
                <input type="range" id="w-gender" min="0" max="100" value="50">
            </div>
            <div class="list-item">
                <span class="list-label" style="font-size:13px;">ğŸ“Š ì„±ì  ê· í˜•</span>
                <input type="range" id="w-level" min="0" max="100" value="30">
            </div>
            <div class="list-item">
                <span class="list-label" style="font-size:13px; color:var(--ios-red);">ğŸ’” ê¸°í”¼ íšŒí”¼</span>
                <input type="range" id="w-avoid" min="0" max="100" value="90">
            </div>
        </div>

        <div class="ios-header" style="padding-bottom:5px;">
            <span style="font-size:12px; color:var(--ios-gray); font-weight:600;">STUDENT LIST (ë²ˆí˜¸ìˆœ)</span>
        </div>
        <div id="student-list-container">
            </div>

        <div class="bottom-action">
            <button class="ios-btn" onclick="runAI()">
                <span>âš¡ AI ìµœì  ë°°ì¹˜ ì‹¤í–‰</span>
            </button>
        </div>
    </div>

    <div id="classroom">
        <div id="blackboard">ì¹  íŒ</div>
        <div id="loading">AIê°€ ìµœì ì˜ ìë¦¬ë¥¼ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤... ğŸ§ </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let GRID_GAP_X = 130;
        let GRID_GAP_Y = 90;
        let GRID_START_Y = 100;
        
        // ëœë¤ ë°ì´í„°
        const names = ['ë¯¼ì¤€','ì„œì¤€','ë„ìœ¤','ì˜ˆì¤€','ì‹œìš°','í•˜ì¤€','ì§€í˜¸','ì§€ìš°','ì„œí˜„','ì„œì—°','ì§€ìœ ','ì§€ì•„'];
        function getRandomName() { return names[Math.floor(Math.random()*names.length)]; }

        window.onload = function() {
            const sel = document.getElementById('student-count');
            for(let i=1; i<=40; i++) {
                let opt = document.createElement('option');
                opt.value = i; opt.text = i+"ëª…";
                if(i===12) opt.selected = true;
                sel.appendChild(opt);
            }
            initClass();
        };

        function initClass() {
            const count = parseInt(document.getElementById('student-count').value);
            const container = document.getElementById('student-list-container');
            
            // ê¸°ì¡´ ë°ì´í„° ë°±ì—… ë¡œì§ ìƒëµ(ë‹¨ìˆœí™”ë¥¼ ìœ„í•´) - í•„ìš”ì‹œ ì¶”ê°€ ê°€ëŠ¥
            container.innerHTML = '';
            document.querySelectorAll('.desk').forEach(d=>d.remove());

            for(let i=1; i<=count; i++) {
                const row = document.createElement('div');
                row.className = 'student-row';
                
                // HTML êµ¬ì¡°: ë²ˆí˜¸ | ì´ë¦„ | ê¸°í”¼ì¹œêµ¬ | ì„±ë³„Btn | ì„±ì Btn
                row.innerHTML = `
                    <span class="student-number">${i}</span>
                    <input type="text" class="input-name" placeholder="ì´ë¦„" value="${getRandomName()}">
                    <input type="text" class="input-avoid" placeholder="ê¸°í”¼ëŒ€ìƒ ì´ë¦„">
                    <div class="toggle-btn gender-m" onclick="toggleGender(this)" data-val="m">ë‚¨</div>
                    <div class="toggle-btn level-mid" onclick="toggleLevel(this)" data-val="2">ì¤‘</div>
                `;
                container.appendChild(row);
            }
            // ë¹ˆ ì±…ìƒ ë¯¸ë¦¬ ë°°ì¹˜
            renderDesks([]); 
        }

        // í† ê¸€ í•¨ìˆ˜ë“¤
        function toggleGender(btn) {
            if(btn.dataset.val === 'm') {
                btn.dataset.val = 'f'; btn.className = 'toggle-btn gender-f'; btn.innerText = 'ì—¬';
            } else {
                btn.dataset.val = 'm'; btn.className = 'toggle-btn gender-m'; btn.innerText = 'ë‚¨';
            }
        }
        function toggleLevel(btn) {
            const v = parseInt(btn.dataset.val);
            if(v === 3) { btn.dataset.val = 1; btn.className = 'toggle-btn level-low'; btn.innerText = 'í•˜'; }
            else if(v === 1) { btn.dataset.val = 2; btn.className = 'toggle-btn level-mid'; btn.innerText = 'ì¤‘'; }
            else { btn.dataset.val = 3; btn.className = 'toggle-btn level-high'; btn.innerText = 'ìƒ'; }
        }

        // --- í•µì‹¬: AI ì•Œê³ ë¦¬ì¦˜ ì‹¤í–‰ ---
        function runAI() {
            document.getElementById('loading').style.display = 'flex';
            
            // UI ë Œë”ë§ì„ ìœ„í•´ setTimeout ì‚¬ìš©
            setTimeout(() => {
                const result = calculateBestLayout();
                renderDesks(result);
                document.getElementById('loading').style.display = 'none';
            }, 100);
        }

        function calculateBestLayout() {
            // 1. ë°ì´í„° ìˆ˜ì§‘
            const rows = document.querySelectorAll('.student-row');
            let students = [];
            rows.forEach((row, idx) => {
                const name = row.querySelector('.input-name').value.trim() || `í•™ìƒ${idx+1}`;
                const avoid = row.querySelector('.input-avoid').value.trim();
                const gender = row.querySelector('.toggle-btn[data-val]').dataset.val; // 'm' or 'f'
                const level = parseInt(row.querySelectorAll('.toggle-btn')[1].dataset.val); // 1, 2, 3
                
                students.push({ id: idx, name, avoid, gender, level });
            });

            const groupCount = parseInt(document.getElementById('group-count').value);
            const wGender = parseInt(document.getElementById('w-gender').value);
            const wLevel = parseInt(document.getElementById('w-level').value);
            const wAvoid = parseInt(document.getElementById('w-avoid').value) * 10; // ê¸°í”¼ëŠ” ê°€ì¤‘ì¹˜ ë»¥íŠ€ê¸°

            let bestScore = -Infinity;
            let bestGrouping = []; // [ [stu1, stu2], [stu3, stu4] ... ]

            // 2. ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ (1000ë²ˆ ë°˜ë³µ)
            for(let iter=0; iter<1000; iter++) {
                // ì…”í”Œ
                let shuffled = [...students].sort(() => Math.random() - 0.5);
                
                // ê·¸ë£¹ ë‚˜ëˆ„ê¸°
                let groups = Array.from({length: groupCount}, () => []);
                shuffled.forEach((stu, i) => {
                    groups[i % groupCount].push(stu);
                });

                // ì ìˆ˜ ê³„ì‚° (Penalty ë°©ì‹: ì ìˆ˜ê°€ ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ, íŒ¨ë„í‹°ëŠ” ë§ˆì´ë„ˆìŠ¤)
                let currentScore = 0;

                groups.forEach(g => {
                    // (1) ì„±ë³„ ê· í˜•: ë‚¨ë…€ ì°¨ì´ê°€ ì ì„ìˆ˜ë¡ ì¢‹ìŒ
                    let males = g.filter(s => s.gender === 'm').length;
                    let females = g.length - males;
                    currentScore -= Math.abs(males - females) * wGender;

                    // (2) ì„±ì  ê· í˜•: ê·¸ë£¹ ë‚´ í‰ê· ì´ ì „ì²´ í‰ê· (2.0)ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì¢‹ìŒ (ë¶„ì‚° ìµœì†Œí™”)
                    let sumLevel = g.reduce((a,b) => a + b.level, 0);
                    let avgLevel = g.length ? sumLevel / g.length : 0;
                    currentScore -= Math.abs(avgLevel - 2.0) * wLevel * 5; 

                    // (3) ê¸°í”¼ ê´€ê³„ í™•ì¸ (ê°€ì¥ ì¤‘ìš”)
                    g.forEach(s => {
                        if(s.avoid) {
                            // ê¸°í”¼ ëŒ€ìƒì´ ê°™ì€ ê·¸ë£¹ì— ìˆëŠ”ì§€ í™•ì¸
                            if(g.some(mate => mate.name === s.avoid)) {
                                currentScore -= wAvoid * 100; // ì—„ì²­ë‚œ ê°ì 
                            }
                        }
                    });
                });

                // ìµœì‹  ê¸°ë¡ ê°±ì‹ 
                if(currentScore > bestScore) {
                    bestScore = currentScore;
                    bestGrouping = JSON.parse(JSON.stringify(groups));
                }
            }
            
            // ê·¸ë£¹í™”ëœ ë°ì´í„°ë¥¼ ì¼ë ¬ ë°°ì—´ë¡œ í’€ì–´ì„œ ë¦¬í„´ (ìë¦¬ ë°°ì¹˜ìš©)
            // Group 1 ë©¤ë²„ë“¤ -> Group 2 ë©¤ë²„ë“¤ ... ìˆœì„œ
            let flatResult = [];
            bestGrouping.forEach((g, gIdx) => {
                g.forEach(s => {
                    s.groupNum = gIdx + 1; // ëª‡ ëª¨ë‘ ì¸ì§€ íƒœê¹…
                    flatResult.push(s);
                });
            });
            return flatResult;
        }

        function renderDesks(studentData) {
            const classroom = document.getElementById('classroom');
            const currentDesks = document.querySelectorAll('.desk');
            currentDesks.forEach(d => d.remove());

            const count = parseInt(document.getElementById('student-count').value);
            // í•™ìƒ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ìë¦¬ ìƒì„±
            const data = studentData.length ? studentData : Array.from({length:count}, (_,i)=>({name:`ìë¦¬${i+1}`, groupNum:0}));

            // ë°°ì¹˜ ê³„ì‚° (ëª¨ë‘ í˜• ë°°ì¹˜ ì‹œê°í™”)
            // 4ì—´ ë°°ì¹˜ ì˜ˆì‹œ
            const cols = 4;
            const classroomWidth = classroom.clientWidth;
            const totalWidth = (cols - 1) * GRID_GAP_X + 110;
            let startX = (classroomWidth - totalWidth) / 2;
            if(startX < 20) startX = 20;

            data.forEach((stu, i) => {
                const desk = document.createElement('div');
                desk.className = `desk g-${stu.groupNum > 6 ? 6 : stu.groupNum}`; // ìƒ‰ìƒ í´ë˜ìŠ¤
                
                const colIndex = i % cols;
                const rowIndex = Math.floor(i / cols);
                
                // ëª¨ë‘ ë¼ë¦¬ ì•½ê°„ ë„ìš°ê¸° (ì˜µì…˜) - ì—¬ê¸°ì„  ë‹¨ìˆœ ê²©ìë¡œ í•¨
                const x = startX + (colIndex * GRID_GAP_X);
                const y = GRID_START_Y + (rowIndex * GRID_GAP_Y);

                desk.style.left = x + 'px';
                desk.style.top = y + 'px';
                
                desk.innerHTML = `
                    <span class="name">${stu.name}</span>
                    ${stu.groupNum ? `<span class="info">${stu.groupNum}ëª¨ë‘ </span>` : ''}
                `;
                
                classroom.appendChild(desk);
                makeDraggable(desk);
            });
        }

        // ë“œë˜ê·¸ ê¸°ëŠ¥ (Snap)
        function makeDraggable(elmnt) {
            let pos1=0, pos2=0, pos3=0, pos4=0;
            elmnt.onmousedown = dragMouseDown;
            function dragMouseDown(e) {
                e.preventDefault(); pos3=e.clientX; pos4=e.clientY;
                elmnt.style.transition = 'none'; // ë“œë˜ê·¸ ì¦‰ì‹œ ë°˜ì‘
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            function elementDrag(e) {
                e.preventDefault();
                pos1=pos3-e.clientX; pos2=pos4-e.clientY;
                pos3=e.clientX; pos4=e.clientY;
                elmnt.style.top=(elmnt.offsetTop-pos2)+"px";
                elmnt.style.left=(elmnt.offsetLeft-pos1)+"px";
            }
            function closeDragElement() {
                document.onmouseup=null; document.onmousemove=null;
                elmnt.style.transition = 'top 0.4s, left 0.4s'; // ë‹¤ì‹œ ë¶€ë“œëŸ½ê²Œ
                // Snap Logic ìƒëµí•˜ê±°ë‚˜ ê°„ë‹¨íˆ êµ¬í˜„ ê°€ëŠ¥
            }
        }
    </script>
</body>
</html>
