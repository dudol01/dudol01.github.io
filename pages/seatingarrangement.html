<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Classroom Seat - iOS Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="../css/global.css" rel="stylesheet">
    <style>
        /* --- iOS Design System --- */
        :root {
            --ios-bg: transparent;
            /* Use global background */
            --ios-card: rgba(255, 255, 255, 0.8);
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-text: #1C1C1E;
            --ios-gray: #8E8E93;
            --ios-border: rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --desk-radius: 14px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            /* background-color: var(--ios-bg); Handled by global.css */
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            color: var(--ios-text);
            overflow: hidden;
        }

        /* --- 왼쪽 설정 패널 (Settings App 스타일) --- */
        #sidebar {
            width: 340px;
            background: rgba(242, 242, 247, 0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            z-index: 20;
            padding: 20px 0;
        }

        .ios-header {
            padding: 0 20px 15px 20px;
        }

        .ios-header h1 {
            font-size: 28px;
            font-weight: 800;
            margin: 0;
            letter-spacing: -0.5px;
        }

        /* iOS List Group 스타일 */
        .list-group {
            background: var(--ios-card);
            border-radius: 12px;
            margin: 0 16px 20px 16px;
            padding: 0 16px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--ios-border);
            font-size: 16px;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-label {
            font-weight: 500;
        }

        /* 커스텀 셀렉트 박스 */
        select {
            border: none;
            background: transparent;
            font-size: 16px;
            color: var(--ios-blue);
            font-weight: 500;
            text-align: right;
            cursor: pointer;
            outline: none;
            direction: rtl;
            /* 화살표 위치 조정 꼼수 */
        }

        /* 학생 명단 리스트 */
        #student-list-container {
            flex: 1;
            overflow-y: auto;
            margin: 0 16px 10px 16px;
        }

        .student-row {
            background: var(--ios-card);
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
            transition: transform 0.1s;
        }

        .student-number {
            width: 28px;
            height: 28px;
            background: rgba(242, 242, 247, 0.8);
            color: var(--ios-gray);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            margin-right: 12px;
        }

        .student-input {
            border: none;
            font-size: 16px;
            width: 100%;
            outline: none;
            background: transparent;
        }

        .level-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            background-color: rgba(242, 242, 247, 0.8);
            color: var(--ios-gray);
            cursor: pointer;
        }

        /* 하단 버튼 영역 */
        .bottom-action {
            padding: 16px;
            background: transparent;
            /* glassmorphism effect for footer handled by sidebar bg */
        }

        .ios-btn {
            width: 100%;
            background-color: var(--ios-blue);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
        }

        .ios-btn:active {
            transform: scale(0.96);
            background-color: #0062cc;
        }

        /* --- 오른쪽 교실 영역 --- */
        #classroom {
            flex: 1;
            position: relative;
            background-color: transparent;
            /* 책상 배치 배경은 약간 어둡게 -> Transparent for global bg */
            /* background-image: radial-gradient(#C7C7CC 1px, transparent 1px); Remove grid or make it subtle white */
            background-image: radial-gradient(rgba(255, 255, 255, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            z-index: 10;
        }

        /* 칠판 */
        #blackboard {
            position: absolute;
            top: 20px;
            width: 60%;
            height: 40px;
            background: rgba(58, 58, 60, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 5;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* iOS 위젯 스타일 책상 */
        .desk {
            width: 110px;
            height: 70px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--desk-radius);
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            cursor: grab;
            user-select: none;
            z-index: 10;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid transparent;
            /* 모둠 색상용 */
        }

        .desk span.name {
            font-size: 17px;
            font-weight: 700;
            color: var(--ios-text);
        }

        .desk span.group-label {
            font-size: 10px;
            color: var(--ios-gray);
            margin-top: 2px;
            text-transform: uppercase;
        }

        .desk:active {
            cursor: grabbing;
            transform: scale(1.1);
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .desk.snapping {
            transition: left 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), top 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* 모둠별 테두리 색상 (iOS 파스텔톤) */
        .group-1 {
            border-color: #FF3B30;
            background: rgba(255, 240, 240, 0.9);
        }

        /* Red */
        .group-2 {
            border-color: #FF9500;
            background: rgba(255, 248, 230, 0.9);
        }

        /* Orange */
        .group-3 {
            border-color: #FFCC00;
            background: rgba(255, 253, 230, 0.9);
        }

        /* Yellow */
        .group-4 {
            border-color: #34C759;
            background: rgba(232, 251, 235, 0.9);
        }

        /* Green */
        .group-5 {
            border-color: #007AFF;
            background: rgba(230, 242, 255, 0.9);
        }

        /* Blue */
        .group-6 {
            border-color: #5856D6;
            background: rgba(239, 235, 255, 0.9);
        }

        /* Indigo */
        .group-7 {
            border-color: #AF52DE;
            background: rgba(248, 230, 255, 0.9);
        }

        /* Purple */
        .group-8 {
            border-color: #FF2D55;
            background: rgba(255, 230, 234, 0.9);
        }

        /* Pink */

        /* 스크롤바 숨기기 */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
    </style>
</head>

<body class="pt-20">

    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>

    <div id="sidebar">
        <div class="ios-header">
            <h1>자리 배치</h1>
        </div>

        <div class="list-group">
            <div class="list-item">
                <span class="list-label">학생 수</span>
                <select id="student-count" onchange="initClass()">
                </select>
            </div>
            <div class="list-item">
                <span class="list-label">모둠(조) 개수</span>
                <select id="group-count">
                    <option value="0">사용 안 함</option>
                    <option value="2">2개 조</option>
                    <option value="3">3개 조</option>
                    <option value="4" selected>4개 조</option>
                    <option value="5">5개 조</option>
                    <option value="6">6개 조</option>
                    <option value="7">7개 조</option>
                    <option value="8">8개 조</option>
                </select>
            </div>
        </div>

        <div class="ios-header" style="padding-bottom:5px;">
            <span
                style="font-size:13px; color:var(--ios-gray); font-weight:600; text-transform:uppercase; margin-left:16px;">STUDENTS
                LIST</span>
        </div>

        <div id="student-list-container">
        </div>

        <div class="bottom-action">
            <button class="ios-btn" onclick="assignSeats()">
                자리 섞기
            </button>
        </div>
    </div>

    <div id="classroom">
        <div id="blackboard">칠 판</div>
    </div>

    <script src="../js/nav.js"></script>
    <script>
        /* --- Logic --- */

        let GRID_GAP_X = 130;
        let GRID_GAP_Y = 90;
        let GRID_START_X = 0;
        let GRID_START_Y = 120;

        // 랜덤 이름 (예시)
        const lastNames = ['김', '이', '박', '최', '정', '강', '조', '윤', '장', '임', '한', '오'];
        const firstNames = ['민준', '서준', '도윤', '예준', '시우', '하준', '지호', '주원', '지우', '서현', '서연', '지유'];

        function getRandomName() {
            return lastNames[Math.floor(Math.random() * lastNames.length)] +
                firstNames[Math.floor(Math.random() * firstNames.length)];
        }

        window.onload = function () {
            // 학생 수 옵션 (1~40)
            const select = document.getElementById('student-count');
            for (let i = 1; i <= 40; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = i + "명";
                if (i === 12) option.selected = true;
                select.appendChild(option);
            }
            initClass();
        };

        // 교실 초기화 및 입력창 생성
        function initClass() {
            const count = parseInt(document.getElementById('student-count').value);
            const listContainer = document.getElementById('student-list-container');
            const classroom = document.getElementById('classroom');

            // 1. 기존 리스트 저장 (이름 유지용)
            const existingInputs = document.querySelectorAll('.student-input');
            let currentNames = [];
            existingInputs.forEach(input => currentNames.push(input.value));

            // 리셋
            listContainer.innerHTML = '';
            document.querySelectorAll('.desk').forEach(d => d.remove());

            // 2. 입력창 생성 (번호순)
            for (let i = 1; i <= count; i++) {
                const row = document.createElement('div');
                row.className = 'student-row';

                // 번호 배지
                const numBadge = document.createElement('div');
                numBadge.className = 'student-number';
                numBadge.textContent = i;

                // 이름 입력
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'student-input';
                nameInput.placeholder = '이름 입력';
                // 기존 입력값이 있으면 유지, 없으면 랜덤 (또는 빈칸)
                if (i <= currentNames.length && currentNames[i - 1]) {
                    nameInput.value = currentNames[i - 1];
                } else {
                    nameInput.value = getRandomName(); // 테스트용 랜덤, 실사용시 "" 권장
                }

                // 성적(상중하) 토글 - 간단한 클릭형
                const levelBadge = document.createElement('div');
                levelBadge.className = 'level-badge';
                levelBadge.textContent = '중'; // 기본값
                levelBadge.dataset.val = 'mid';
                levelBadge.onclick = function () {
                    if (this.dataset.val === 'mid') { this.textContent = '상'; this.dataset.val = 'high'; this.style.color = '#FF3B30'; }
                    else if (this.dataset.val === 'high') { this.textContent = '하'; this.dataset.val = 'low'; this.style.color = '#007AFF'; }
                    else { this.textContent = '중'; this.dataset.val = 'mid'; this.style.color = '#8E8E93'; }
                };

                row.appendChild(numBadge);
                row.appendChild(nameInput);
                row.appendChild(levelBadge);
                listContainer.appendChild(row);
            }

            // 3. 책상 생성 (초기 상태)
            createDesks(count);
        }

        function createDesks(count) {
            const classroom = document.getElementById('classroom');
            const cols = 4; // 4열 배치 기본
            const classroomWidth = classroom.clientWidth;
            const totalWidth = (cols - 1) * GRID_GAP_X + 110;
            GRID_START_X = (classroomWidth - totalWidth) / 2;
            if (GRID_START_X < 20) GRID_START_X = 20;

            for (let i = 0; i < count; i++) {
                const desk = document.createElement('div');
                desk.className = 'desk';
                desk.id = 'desk-' + i;

                const colIndex = i % cols;
                const rowIndex = Math.floor(i / cols);

                const x = GRID_START_X + (colIndex * GRID_GAP_X);
                const y = GRID_START_Y + (rowIndex * GRID_GAP_Y);

                desk.style.left = x + 'px';
                desk.style.top = y + 'px';
                desk.innerHTML = `<span class="name">자리 ${i + 1}</span>`;

                classroom.appendChild(desk);
                makeDraggable(desk);
            }
        }

        // 자리 배치 알고리즘
        function assignSeats() {
            const inputs = document.querySelectorAll('.student-input');
            const levels = document.querySelectorAll('.level-badge');
            const groupCount = parseInt(document.getElementById('group-count').value);

            let students = [];
            inputs.forEach((input, idx) => {
                let name = input.value.trim() || "(공석)";
                students.push({
                    name: name,
                    level: levels[idx].dataset.val
                });
            });

            // 셔플 (Fisher-Yates)
            for (let i = students.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [students[i], students[j]] = [students[j], students[i]];
            }

            const desks = document.querySelectorAll('.desk');

            // 모둠 할당 로직 (단순 균등 분배)
            let groupAssignments = [];
            if (groupCount > 0) {
                // 학생 수만큼 1~GroupCount 반복
                for (let i = 0; i < students.length; i++) {
                    groupAssignments.push((i % groupCount) + 1);
                }
                // 모둠 번호도 섞어줌 (자리 배치와 별개로 모둠 구성을 섞음)
                for (let i = groupAssignments.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [groupAssignments[i], groupAssignments[j]] = [groupAssignments[j], groupAssignments[i]];
                }
            }

            // 애니메이션 효과
            desks.forEach(desk => {
                desk.style.transform = 'scale(0.8)';
                desk.style.opacity = '0.5';
            });

            setTimeout(() => {
                desks.forEach((desk, index) => {
                    if (index < students.length) {
                        desk.style.transform = 'scale(1)';
                        desk.style.opacity = '1';

                        // 내용 업데이트
                        let html = `<span class="name">${students[index].name}</span>`;

                        // 기존 클래스 제거 (group-1, group-2 ...)
                        desk.className = 'desk';

                        // 모둠 설정이 되어있다면
                        if (groupCount > 0) {
                            let gNum = groupAssignments[index];
                            html += `<span class="group-label">${gNum}모둠</span>`;
                            desk.classList.add(`group-${gNum}`); // 색상 적용 클래스
                        }

                        desk.innerHTML = html;
                    }
                });
            }, 200);
        }

        /* --- Drag & Drop (Snap to Grid) --- */
        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                elmnt.classList.remove('snapping');
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;

                // Snap Logic
                let colIndex = Math.round((elmnt.offsetLeft - GRID_START_X) / GRID_GAP_X);
                let rowIndex = Math.round((elmnt.offsetTop - GRID_START_Y) / GRID_GAP_Y);

                let newLeft = GRID_START_X + (colIndex * GRID_GAP_X);
                let newTop = GRID_START_Y + (rowIndex * GRID_GAP_Y);
                if (newTop < 80) newTop = 80; // 칠판 침범 방지

                elmnt.classList.add('snapping');
                elmnt.style.left = newLeft + "px";
                elmnt.style.top = newTop + "px";
            }
        }

        // 리사이즈 대응
        window.addEventListener('resize', () => {
            const count = parseInt(document.getElementById('student-count').value);
            // 위치만 재조정하지 않고 간단히 desks를 다시 그리지 않음 (드래그 위치 유지 위해)
            // 다만 화면이 너무 바뀌면 GRID_START_X 재계산 필요
            const classroom = document.getElementById('classroom');
            const cols = 4;
            const totalWidth = (cols - 1) * GRID_GAP_X + 110;
            GRID_START_X = (classroom.clientWidth - totalWidth) / 2;
            if (GRID_START_X < 20) GRID_START_X = 20;
        });

    </script>
</body>

</html>